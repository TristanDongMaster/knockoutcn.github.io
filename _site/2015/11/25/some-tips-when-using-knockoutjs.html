
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>使用knockoutjs的一些注意点</title>
    <meta name="description" content="">
    <meta name="author" content="wikieswan">

    <link rel="icon" href="//learn.knockoutjs.com/Content/App/icon.png" type="image/png" sizes="16x16">
    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="http://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="http://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">


    <link href="http://cdn.bootcss.com/highlight.js/8.0/styles/monokai_sublime.min.css" rel="stylesheet">  


  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">knockoutjs 中文</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/api">API</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/aqshare">分享</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive">所有文章</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">所有页面</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  



          </ul>
          
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>使用knockoutjs的一些注意点 </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>25 November 2015</span>
    </div>
    <div class="content">
      
<p>knockoutjs 使用也有一段时间了，总结了一些坑，希望对你有帮助。</p>

<h2 id="knockoutjs">为什么选择 knockoutjs</h2>

<p>市面上有很多mvvm框架，angularjs 、 vuejs ，<a href="https://github.com/RubyLouvre/avalon/issues/480">我所知道的MVVM框架</a> ，详细了解点击这里。</p>

<p>我选择 knockoutjs 的理由是：</p>

<ul>
  <li>
    <p>knockoutjs 支持市面上所有浏览器，少有的能支持 ie6 这个上古神器的 mvvm 框架，这样生产代码就不需要过多的 hack 来解决头疼的兼容问题 。</p>
  </li>
  <li>
    <p>knockoutjs 是一个纯 mvvm 框架，只做UI，不做其他任何事情。这样我很容易把它集成到现有的工程里 。 对于需要改造的页面，针对性使用就好了 。</p>
  </li>
  <li>
    <p>可以全站使用，也可以部分页面使用，也可以页面部分区域（div块）使用，单页面应用也可以使用。典型的是有位同学把knockoutjs和backbone结合起来搞了个框架，具体可以去github找下。</p>
  </li>
  <li>
    <p>knockoutjs 是微软团队支持开发的，最早一次commit是 Commits on Jul 5, 2010 。</p>
  </li>
</ul>

<p>其实说起来，真正让我使用它还是第一条 – 兼容性。angularjs react等，尤其是react，里面有很多黑科技，确实很好用，内部项目对浏览器兼容性没有要求的，我还是会选择后两者。</p>

<p>并不是所有页面都需要使用 knockoutjs ，我认为复杂的DOM操作，VIEW变化频繁的站点，使用 knockoutjs会减少大量代码 ，可维护性也强。不满足上面条件的页面，可以用传统方式来操作。</p>

<p>knockoutjs 的缺点</p>

<ul>
  <li>
    <p>相对其他 mvvm 框架，不够热，相对小众。</p>
  </li>
  <li>
    <p>写法繁琐，不如angularjs 的 <code>{ { } }</code> 来的直接。</p>
  </li>
</ul>

<p>看了上面，如果觉得你需要使用 knockoutjs ，那我们继续往下看吧。</p>

<h2 id="knockoutjs-">knockoutjs 函数对象为主体</h2>

<p>knockoutjs 中，函数是第一对象，只要用 使用 ko.observable() 接口进行数据绑定，那么生成的对象就是个函数了，那么接下来使用它都要以函数的形式 。</p>

<p>举个例子</p>

<pre><code>Today's message is: &lt;span data-bind="text: myMessage"&gt;&lt;/span&gt;

var viewModel = {
    myMessage: ko.observable() // Initially blank
};
viewModel.myMessage("Hello, world!"); // Text appears
ko.applyBindings(viewModel);
</code></pre>

<p>viewModel.myMessage 对象经过 ko.observable() 绑定后，就变成了一个函数 ，这个函数需要一个参数，就是要绑定的值。</p>

<p>这里顺便提一下 foreach 绑定，有些情况是需要在表格第一列显示序列号的，这时候 我们用 $index() ,因为它也是个函数 。</p>

<p>至于不清楚是否是函数的对象，你就先用对象本身，如果报错，再使用函数形式（就是在对象后面加对括号，够直白吧）。</p>

<h2 id="koapplybindings-">ko.applyBindings 的小技巧</h2>

<p>注意 ko.applyBindings() 函数有两个参数，分别是数据对象和绑定的视图 DOM节点 。默认呢，第二个参数为空，如果不写，就代表绑定到整个html文档上去了，这时候如果你再执行一次 ko.applyBindings 就会报错，因为一个DOM节点只能绑定一次。这种情况，我会给ko.applyBindings 传递第二个参数 —— 绑定的DOM节点 。 这样的好处是，当再次执行绑定，只要DOM节点不一样就不会报错，这在单页面应用开发会很有作用 。</p>

<h2 id="viewmodel-">viewModel 最好用构造函数进行初始化</h2>

<p>像上面那个例子 viewModel 是用 var 来声明的，而我一般会选择用构造函数来声明，比如上面代码可以像下面这样改造</p>

<pre><code>function ViewModel(){
	var self = this;
	self.myMessage = ko.observable() ;
}
var viewModel = new ViewModel();
ko.applyBindings(viewModel,$('body')[0]);


viewModel.myMessage("Hello, world!"); // Text appears
</code></pre>

<p>这样写的好处是，一般情况下，我们的视图代码都不会像官方demo那么简单，可能需要大幅代码，这样用构造函数的话，由于js代码中函数第一，声明会优先上升。这样把视图的构造函数放在什么地方都无所谓了。还有就是，构造函数可以传参，初始化值可以在生成对象的时候就传递过去。还有对象的修改不影响构造函数，看着构造函数就很明确视图的结构了。</p>

<p>当然demo的写法也不是不好，只是用构造函数可能更利于代码的组织。</p>

<h2 id="with">对象多值绑定的时候，用 with</h2>

<p>当需要绑定一个对象下面多个属性的值的时候，请使用with，它会code看起来更简洁。不如这个例子，</p>

<pre><code>&lt;h1 data-bind="text: city"&gt; &lt;/h1&gt;
&lt;p data-bind="with: coords"&gt;
    Latitude: &lt;span data-bind="text: latitude"&gt; &lt;/span&gt;,
    Longitude: &lt;span data-bind="text: longitude"&gt; &lt;/span&gt;
&lt;/p&gt;
 
&lt;script type="text/javascript"&gt;
    ko.applyBindings({
        city: "London",
        coords: {
            latitude:  51.5001524,
            longitude: -0.1262362
        }
    });
&lt;/script&gt;
</code></pre>

<p>如果我们不使用 with 的话，需要在视图里面做多个属性的 ko.observable() 函数调用，如果大对象的，想想都疯了。</p>

<h2 id="section">使用自定义过滤函数，让你的代码更优雅</h2>

<p>这个是借鉴 angularjs的filter属性，在之前的文章也有提到，这里就简单介绍下。</p>

<p>对于需要过滤处理的后端数据，一般我们是在js代码里面直接过滤，比如把后端数据 long 型数值转换成 1,111,000.00 这种形式。原来的做法:</p>

<pre><code>&lt;span data-bind="text: amount"&gt;&lt;/span&gt;

&lt;script type="text/javascript"&gt;
    function ViewModel(){
		var self = this;
		self.amount = ko.observable() ;
	}
	var viewModel = new ViewModel();
	ko.applyBindings(viewModel,$('body')[0]);

	function longToNumber(val){
		// some codes
	}

	var amount = 1111000;
	var newAmount = longToNumber(amount);
	viewModel.amount(newAmount);

&lt;/script&gt;
</code></pre>

<p>如果我们把数据的处理放在 html 代码里面做，代码会更优美点</p>

<pre><code>&lt;span data-bind="text: $root.longToNumber(amount)"&gt;&lt;/span&gt;

&lt;script type="text/javascript"&gt;
    function ViewModel(){
		var self = this;
		self.longToNumber = longToNumber;
		self.amount = ko.observable() ;
	}
	var viewModel = new ViewModel();
	ko.applyBindings(viewModel,$('body')[0]);

	function longToNumber(val){
		// some codes
	}

	var amount = 1111000;
	viewModel.amount(amount);

&lt;/script&gt;
</code></pre>

<p>这样，传递原始值，在html过滤，返回正确的值。业务逻辑更清楚了。</p>

<h2 id="data-bind-json">data-bind 关键字传递的是一个JSON对象</h2>

<p>如果你足够细心，你会发现，所有的 data-bind 后面跟的都是一个 json 对象，如果不是就报错了。例如 text 绑定，</p>

<pre><code>&lt;span data-bind="text: amount"&gt;&lt;/span&gt;
</code></pre>

<p>看到	data-bind 后面是一个 {text: amount} 对象。</p>

<h2 id="dom">同一个DOM节点绑定多个对象</h2>

<p>比如需要在一个按钮上动态绑定显示的文本，同时按钮的点击事件也需要跟着文本变化 ，这就是个典型的同一个DOM节点绑定多个对象。</p>

<p>绑定的方法是在多值绑定之间用逗号分隔。</p>

<pre><code>&lt;button data-bind="text: btnText,click: btnClick"&gt;&lt;/button&gt;

&lt;script type="text/javascript"&gt;
    function ViewModel(){
		var self = this;
		self.btnClick = btnClick;
		self.btnText = ko.observable() ;
	}
	var viewModel = new ViewModel();
	ko.applyBindings(viewModel,$('body')[0]);

	function btnClick(val){
		// some codes
	}

	viewModel.btnText('like me');

&lt;/script&gt;
</code></pre>

<p>还是上面说的 data-bind 关键字传递的是一个JSON对象 ，看到现在传递的是</p>

<pre><code>{
	text: btnText,
	click: btnClick
}
</code></pre>

<h2 id="js-class-">绑定的属性避免使用js保留字 class 等</h2>

<p>因为在老浏览器中，js 保留字作为属性名会报错。</p>

<h2 id="section-1">学会使用注释绑定（虚拟元素）</h2>

<pre><code>&lt;!-- ko text: name --&gt;&lt;!-- /ko --&gt;
</code></pre>

<p>虚拟元素绑定的好处是，不会引入多余的DOM元素来影响页面样式，（react就会强制引入span做绑定）。</p>

<h2 id="foreach--as">foreach 绑定记得使用 as别名</h2>

<p>防止引用出错，详细见<a href="http://knockoutcn.github.io/knockoutjs%20api/2015/11/25/foreach-bind/">foreach 绑定</a></p>

<h2 id="section-2">绑定的上下文要弄清楚</h2>

<p>绑定的上下文容易导致一些错误，初学者常犯。具体分析看这篇文章——<a href="http://knockoutcn.github.io/knockoutjs%20api/2015/11/25/bind-context/">绑定的上下文</a></p>

<p>待续…</p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#share-ref">
    		share <span>3</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#share-ref">share <span>3</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/2015/11/25/ifnot-bind" title="ifnot bind">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/2015/11/25/style-bind" title="style bind">Next &raquo;</a></li>
    
    </ul>
    <hr>
    


  <div id="ds-thread" class="ds-thread" data-url="/2015/11/25/some-tips-when-using-knockoutjs" data-title="使用knockoutjs的一些注意点" data-thread-key="使用knockoutjs的一些注意点"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name: 'wan'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>



  </div>
</div>


      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2015 wikieswan 欢迎分享，转载请注明出处。
      </div>
    </div>


    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
    <script src="http://cdn.bootcss.com/highlight.js/8.0/highlight.min.js"></script>  
    <script>hljs.initHighlightingOnLoad();</script>  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-70707595-1', 'auto');
        ga('send', 'pageview');
    </script>
  </body>
</html>

